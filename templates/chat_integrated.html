<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kid-Friendly Chatbot</title>
    <link rel="stylesheet" href="static/css/styles.css">
</head>
<body>
    <div class="chat-container">
        <img src="static/images/cute-character.png" alt="Cute Character" class="character-icon">
        <h2>üß™ Science-bot ü§ñ</h2>
        <div id="chat-box" class="chat-box">
            <!-- Speech bubbles will be appended here -->
        </div>
        <div class="chat-input">
            <input type="text" id="user-message" placeholder="Type your message here...">
            <button onclick="sendMessage()">Send üì®</button>
            <button id="voice-btn" onclick="handleVoiceInput()">üéôÔ∏è Talk</button>
        </div>
        <div id="action-buttons">
            <button onclick="chat()">Start Chat</button>
            <button onclick="startQuiz()">Take a Science Quiz</button>
            <button onclick="calculator()">Scientific Calculator</button>
            <button onclick="openGame()">Lets Play a Game</button>
        </div>
        <div id="feedback-buttons" class="feedback-buttons" style="display: none;">
            <button onclick="sendFeedback('good')">üëç Good</button>
            <button onclick="sendFeedback('bad')">üëé Bad</button>
        </div>
    </div>

    <script>
        let lastUserMessage = ""; // Store the last user message
        const voiceBtn = document.getElementById("voice-btn");

        // Function to send text message
        function sendMessage() {
            const userMessage = document.getElementById("user-message").value;
            if (!userMessage.trim()) return;

            // Append user's message to chat
            appendUserMessage(userMessage);
            lastUserMessage = userMessage; // Save the last user message

            // Send POST request to Flask backend
            fetch("/chat", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ message: userMessage })
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.bot_message) {
                    handleBotResponse(data.bot_message);
                } else {
                    handleError();  // In case the response doesn't contain the expected data
                }
            })
            .catch(error => {
                console.error("Error:", error);
                handleError();
            });
        }

        // Function to handle bot response
        function handleBotResponse(botMessage) {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML += `<div class="speech-bubble bot-bubble"><p>ü§ñ Bot: ${botMessage}</p></div>`;
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom
        }

        function appendUserMessage(message) {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML += `<div class="speech-bubble user-bubble"><p>üßç You: ${message}</p></div>`;
            chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom
        }

        // Function to start chat
        function startChat() {
            const userName = prompt("What's your name?");
            const userAge = prompt("How old are you?");
            fetch('/start_chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: userName, age: userAge })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                appendUserMessage(data.message);
            });
        }

        // Function to fetch quiz questions
function startQuiz() {
    fetch('/quiz', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ action: 'start' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.action === "start") {
            displayQuestions(data.questions);
        }
    });
}

// Function to display questions on the front-end
function displayQuestions(questions) {
    let quizContainer = document.getElementById('quiz-container');
    quizContainer.innerHTML = ''; // Clear previous content
    questions.forEach((q, index) => {
        let questionDiv = document.createElement('div');
        questionDiv.innerHTML = `
            <p>${q.question}</p>
            <input type="radio" name="q${index}" value="${q.options[0]}"> ${q.options[0]}<br>
            <input type="radio" name="q${index}" value="${q.options[1]}"> ${q.options[1]}<br>
            <input type="radio" name="q${index}" value="${q.options[2]}"> ${q.options[2]}<br>
            <input type="radio" name="q${index}" value="${q.options[3]}"> ${q.options[3]}<br>
        `;
        quizContainer.appendChild(questionDiv);
    });
}

    // Function to submit quiz answers
    function submitQuiz() {
        let answers = [];
        let quizContainer = document.getElementById('quiz-container');
        let questions = quizContainer.getElementsByTagName('div');
        
        for (let i = 0; i < questions.length; i++) {
            let selectedAnswer = questions[i].querySelector('input[type="radio"]:checked');
            if (selectedAnswer) {
                answers.push(selectedAnswer.value);
            } else {
                answers.push('');  // If no answer selected
            }
        }

        fetch('/quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'submit', answers: answers })
        })
        .then(response => response.json())
        .then(data => {
            alert(data.feedback);  // Show feedback message
            console.log(data.detailed_feedback);  // Detailed feedback (optional)
        });
    }


        // Open calculator app
        function calculator() {
            window.location.href = '/calculator';
        }

        // Open game page
        function openGame() {
            window.location.href = '/game';
        }
                // Voice Chat Functionality
                voiceBtn.addEventListener("click", () => {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const mediaRecorder = new MediaRecorder(stream);
                    const chunks = [];

                    mediaRecorder.start();
                    voiceBtn.textContent = "üéôÔ∏è Recording...";
                    setTimeout(() => mediaRecorder.stop(), 5000); // Stop recording after 5 seconds

                    mediaRecorder.ondataavailable = event => chunks.push(event.data);
                    mediaRecorder.onstop = () => {
                        voiceBtn.textContent = "üéôÔ∏è Talk";
                        const audioBlob = new Blob(chunks, { type: "audio/wav" });
                        const formData = new FormData();
                        formData.append("audio", audioBlob);

                        // Send audio to Flask backend
                        fetch("/voice-chat", {
                            method: "POST",
                            body: formData,
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert("Error: " + data.error);
                            } else {
                                appendUserMessage(data.user_message);
                                handleBotResponse(data.bot_message);

                                // Play bot audio response
                                const botAudio = new Audio(data.audio);
                                botAudio.play();
                            }
                        })
                        .catch(error => {
                            console.error("Error:", error);
                            alert("An error occurred. Please try again.");
                        });
                    };
                })
                .catch(error => {
                    console.error("Microphone access denied:", error);
                    alert("Microphone access denied. Please enable it to use voice chat.");
                });
        });
    </script>


</body>
</html>
